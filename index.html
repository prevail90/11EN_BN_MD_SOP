<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>11th Engineer BN DOST SOP</title>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: system-ui, sans-serif;
    }

    nav {
      width: 300px;
      background: #f8f8f8;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
    }
    #downloadContainer {
      padding: 8px;
      border-bottom: 1px solid #ccc;
      background: #eee;
      text-align: center;
    }

    #downloadButton {
      display: inline-block;
      padding: 6px 10px;
      background: #0066cc;
      color: #fff;
      text-decoration: none;
      font-size: 0.9rem;
      border-radius: 4px;
    }

    #downloadButton:hover {
      background: #004c99;
    }

    #searchContainer {
      padding: 8px;
      border-bottom: 1px solid #ccc;
    }

    #searchBox {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      font-size: 0.95rem;
    }
    #bookmarks, #searchResults {
      overflow-y: auto;
      flex: 1;
      padding: 10px;
    }

    #resultsList li {
      margin: 6px 0;
    }

    #resultsList a {
      text-decoration: none;
      color: #333;
      font-size: 0.9rem;
    }

    #resultsList a:hover {
      color: #0066cc;
    }

    #bookmarks {
      overflow-y: auto;
      flex: 1;
      padding: 10px;
    }

    #bookmarks ul {
      list-style: none;
      padding-left: 15px;
      margin: 0;
    }

    #bookmarks li {
      margin: 3px 0;
    }

    #bookmarks a {
      text-decoration: none;
      color: #333;
      font-size: 0.9rem;
    }

    #bookmarks a:hover {
      color: #0066cc;
    }

    #bookmarks h2 {
      font-size: 1rem;
      margin: 10px 0 5px;
      cursor: pointer;
      user-select: none;
    }

    #bookmarks ul.collapsible {
      display: none;
    }

    #bookmarks ul.collapsible.show {
      display: block;
    }

    iframe {
      flex: 1;
      border: none;
      height: 100vh;
    }
  </style>
</head>
<body>
  <nav>
    <div id="downloadContainer">
      <a id="downloadButton" 
         href="https://github.com/prevail90/11EN_BN_MD_SOP/raw/main/BN%20Driver's%20Training%20SOP.pdf" 
         download>
        â¬‡ Download Full PDF
      </a>
    </div>
    <div id="searchContainer">
      <input type="text" id="searchBox" placeholder="Search bookmarks..." />
    </div>
    <div id="searchResults" style="display:none; overflow-y:auto; flex:1; padding:10px;">
      <p><strong>Search Results</strong></p>
      <ul id="resultsList" style="list-style:none; padding-left:0;"></ul>
    </div>
    <div id="bookmarks">
      <!-- Table of contents will be generated here -->
    </div>
  </nav>

  <iframe id="contentFrame" src="BN Driver's Training SOP-1.html" name="contentFrame"></iframe>

  <script>
    // Load the outline HTML and inject its structure
    fetch('BN Driver\'s Training SOP-outline.html')
      .then(res => res.text())
      .then(html => {
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        const outline = doc.querySelector('ul');

        const tocContainer = document.getElementById('bookmarks');
        tocContainer.appendChild(transformOutline(outline));

        // Add collapsible functionality
        tocContainer.querySelectorAll('li > a').forEach(link => {
          // leave as normal links, no changes needed
        });

        tocContainer.querySelectorAll('li').forEach(li => {
          const sublist = li.querySelector('ul');
          if (sublist) {
            const heading = document.createElement('h2');
            const link = li.querySelector('a');
            heading.textContent = link.textContent;
            heading.addEventListener('click', () => {
              sublist.classList.toggle('show');
            });
            li.insertBefore(heading, link);
            link.remove(); // remove top link, we use heading instead
            sublist.classList.add('collapsible');
          }
        });
      });

    function transformOutline(outlineUL) {
      // Clone and adjust links to target the content frame
      const clone = outlineUL.cloneNode(true);
      clone.querySelectorAll('a').forEach(a => {
        a.setAttribute('target', 'contentFrame');
      });
      return clone;
    }

    // Simple bookmark search
    const searchBox = document.getElementById('searchBox');
    searchBox.addEventListener('input', () => {
      const term = searchBox.value.toLowerCase();
      const links = document.querySelectorAll('#bookmarks a');
      links.forEach(link => {
        const text = link.textContent.toLowerCase();
        const li = link.closest('li');
        li.style.display = text.includes(term) ? '' : 'none';
      });
    });
  
  const contentFrame = document.getElementById('contentFrame');

  // This function will attach a scroll listener inside the iframe after it loads
  function attachScrollListener() {
    const iframeDoc = contentFrame.contentDocument || contentFrame.contentWindow.document;

    iframeDoc.addEventListener('scroll', () => {
      const scrollTop = iframeDoc.documentElement.scrollTop || iframeDoc.body.scrollTop;
      const scrollHeight = iframeDoc.documentElement.scrollHeight || iframeDoc.body.scrollHeight;
      const clientHeight = iframeDoc.documentElement.clientHeight || iframeDoc.body.clientHeight;

      // When we're within ~50px of the bottom, go to next page
      if (scrollTop + clientHeight >= scrollHeight - 50) {
        loadNextPage();
      }
    });
  }

  contentFrame.addEventListener('load', attachScrollListener);

  function loadNextPage() {
    const currentUrl = contentFrame.getAttribute('src');
    const match = currentUrl.match(/SOP-(\d+)\.html$/);
    if (match) {
      const currentPage = parseInt(match[1], 10);
      const nextPage = currentPage + 1;
      const nextUrl = currentUrl.replace(`SOP-${currentPage}.html`, `SOP-${nextPage}.html`);

      // Check if next page actually exists by trying to fetch it
      fetch(nextUrl).then(res => {
        if (res.ok) {
          contentFrame.src = nextUrl;
        }
      });
    }
  }
  </script>
  <script>
  const searchBox = document.getElementById('searchBox');
  const bookmarksContainer = document.getElementById('bookmarks');
  const resultsContainer = document.getElementById('searchResults');
  const resultsList = document.getElementById('resultsList');

  const totalPages = 88; // adjust to your actual page count
  const pagePrefix = "BN Driver's Training SOP-";
  const pageSuffix = ".html";
  let pageIndex = [];

  // Load and index all pages at startup
  async function buildIndex() {
    for (let i = 1; i <= totalPages; i++) {
      const url = `${pagePrefix}${i}${pageSuffix}`;
      try {
        const res = await fetch(url);
        if (!res.ok) continue;
        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');
        const text = doc.body.innerText.replace(/\s+/g, ' ').trim();
        pageIndex.push({ page: i, text });
      } catch (e) {
        console.warn('Failed to index page', i, e);
      }
    }
    console.log('Search index ready:', pageIndex.length, 'pages indexed');
  }

  buildIndex();

  // Search both bookmarks and full text
  searchBox.addEventListener('input', () => {
    const term = searchBox.value.trim().toLowerCase();

    if (term === '') {
      // Show bookmarks, hide search results
      bookmarksContainer.style.display = '';
      resultsContainer.style.display = 'none';
      return;
    }

    // Hide bookmarks, show results
    bookmarksContainer.style.display = 'none';
    resultsContainer.style.display = 'block';
    resultsList.innerHTML = '';

    const matches = [];
    for (const { page, text } of pageIndex) {
      const idx = text.toLowerCase().indexOf(term);
      if (idx !== -1) {
        // Grab surrounding snippet
        const start = Math.max(0, idx - 40);
        const end = Math.min(text.length, idx + term.length + 40);
        const snippet = text.substring(start, end).replace(/\n/g, ' ');

        matches.push({
          page,
          snippet: snippet.replace(new RegExp(term, 'ig'), match => `<mark>${match}</mark>`)
        });
      }
    }

    if (matches.length === 0) {
      resultsList.innerHTML = `<li>No matches found.</li>`;
    } else {
      matches.forEach(m => {
        const li = document.createElement('li');
        li.innerHTML = `<a href="${pagePrefix}${m.page}${pageSuffix}" target="contentFrame">
          Page ${m.page}: ${m.snippet}...</a>`;
        resultsList.appendChild(li);
      });
    }
  });
</script>
</body>
</html>
