<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>11th Engineer BN DOST SOP</title>
  <style>
    body {
      margin: 0;
      display: flex;
      height: 100vh;
      font-family: system-ui, sans-serif;
    }

    nav {
      width: 300px;
      background: #f8f8f8;
      border-right: 1px solid #ccc;
      display: flex;
      flex-direction: column;
    }
    #downloadContainer {
      padding: 8px;
      border-bottom: 1px solid #ccc;
      background: #eee;
      text-align: center;
    }

    #downloadButton {
      display: inline-block;
      padding: 6px 10px;
      background: #0066cc;
      color: #fff;
      text-decoration: none;
      font-size: 0.9rem;
      border-radius: 4px;
    }

    #downloadButton:hover {
      background: #004c99;
    }

    #searchContainer {
      padding: 8px;
      border-bottom: 1px solid #ccc;
    }

    #searchBox {
      width: 100%;
      padding: 6px;
      box-sizing: border-box;
      font-size: 0.95rem;
    }
    #bookmarks, #searchResults {
      overflow-y: auto;
      flex: 1;
      padding: 10px;
    }

    #resultsList li {
      margin: 6px 0;
    }

    #resultsList a {
      text-decoration: none;
      color: #333;
      font-size: 0.9rem;
    }

    #resultsList a:hover {
      color: #0066cc;
    }

    #bookmarks {
      overflow-y: auto;
      flex: 1;
      padding: 10px;
    }

    #bookmarks ul {
      list-style: none;
      padding-left: 15px;
      margin: 0;
    }

    #bookmarks li {
      margin: 3px 0;
    }

    #bookmarks a {
      text-decoration: none;
      color: #333;
      font-size: 0.9rem;
    }

    #bookmarks a:hover {
      color: #0066cc;
    }

    #bookmarks h2 {
      font-size: 1rem;
      margin: 10px 0 5px;
      cursor: pointer;
      user-select: none;
    }

    #bookmarks ul.collapsible {
      display: none;
    }

    #bookmarks ul.collapsible.show {
      display: block;
    }

    iframe {
      flex: 1;
      border: none;
      height: 100vh;
    }
    #contentContainer {
  flex: 1;
  overflow-y: auto;
  height: 100vh;
  background: #fff;
}
.page-section {
  border-bottom: 1px solid #ccc;
  margin: 0 auto;
}

  </style>
</head>
<body>
  <nav>
    <div id="downloadContainer">
      <a id="downloadButton" 
         href="https://github.com/prevail90/11EN_BN_MD_SOP/raw/main/BN%20Driver's%20Training%20SOP.pdf" 
         download>
        â¬‡ Download Full PDF
      </a>
    </div>
    <div id="searchContainer">
      <input type="text" id="searchBox" placeholder="Search bookmarks..." />
    </div>
    <div id="searchResults" style="display:none; overflow-y:auto; flex:1; padding:10px;">
      <p><strong>Search Results</strong></p>
      <ul id="resultsList" style="list-style:none; padding-left:0;"></ul>
    </div>
    <div id="bookmarks">
      <!-- Table of contents will be generated here -->
    </div>
  </nav>

  <div id="contentContainer"></div>

  <script>
  // --- GLOBAL CONFIG ---
  const totalPages = 88;
  const pagePrefix = "BN Driver's Training SOP-";
  const pageSuffix = ".html";

  // --- BUILD THE TOC ---
  fetch('BN Driver\'s Training SOP-outline.html')
    .then(res => res.text())
    .then(html => {
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const outline = doc.querySelector('ul');
      const tocContainer = document.getElementById('bookmarks');
      tocContainer.appendChild(transformOutline(outline));
      // collapse/expand headings...
    });

  function transformOutline(outlineUL) {
    const clone = outlineUL.cloneNode(true);
    clone.querySelectorAll('a').forEach(a => {
      a.removeAttribute('target'); // no iframe anymore
    });
    return clone;
  }

  // --- LOAD PAGES INTO ONE SCROLLABLE CONTAINER ---
  const contentContainer = document.getElementById('contentContainer');

  async function loadPages() {
    for (let i = 1; i <= totalPages; i++) {
      const url = `${pagePrefix}${i}${pageSuffix}`;
      const res = await fetch(url);
      if (!res.ok) continue;
      const html = await res.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');
      const pageDiv = document.createElement('div');
      pageDiv.className = 'page-section';
      pageDiv.id = `page-${i}`;
      pageDiv.innerHTML = doc.body.innerHTML;
      contentContainer.appendChild(pageDiv);
    }
    console.log('All pages appended');
  }

  loadPages();

  // --- BUILD TEXT SEARCH INDEX ---
  const bookmarksContainer = document.getElementById('bookmarks');
  const resultsContainer = document.getElementById('searchResults');
  const resultsList = document.getElementById('resultsList');
  const searchBox = document.getElementById('searchBox');

  let pageIndex = [];

  async function buildIndex() {
    for (let i = 1; i <= totalPages; i++) {
      const url = `${pagePrefix}${i}${pageSuffix}`;
      const res = await fetch(url);
      if (!res.ok) continue;
      const html = await res.text();
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const text = doc.body.innerText.replace(/\s+/g, ' ').trim();
      pageIndex.push({ page: i, text });
    }
    console.log('Search index ready:', pageIndex.length, 'pages indexed');
  }

  buildIndex();

  // --- SEARCH ---
  searchBox.addEventListener('input', () => {
    const term = searchBox.value.trim().toLowerCase();
    if (term === '') {
      bookmarksContainer.style.display = '';
      resultsContainer.style.display = 'none';
      return;
    }
    bookmarksContainer.style.display = 'none';
    resultsContainer.style.display = 'block';
    resultsList.innerHTML = '';

    const matches = [];
    for (const { page, text } of pageIndex) {
      const idx = text.toLowerCase().indexOf(term);
      if (idx !== -1) {
        const start = Math.max(0, idx - 40);
        const end = Math.min(text.length, idx + term.length + 40);
        const snippet = text.substring(start, end).replace(/\n/g, ' ');
        matches.push({
          page,
          snippet: snippet.replace(new RegExp(term, 'ig'), m => `<mark>${m}</mark>`)
        });
      }
    }

    if (matches.length === 0) {
      resultsList.innerHTML = `<li>No matches found.</li>`;
    } else {
      matches.forEach(m => {
        const li = document.createElement('li');
        li.innerHTML = `<a href="#page-${m.page}">Page ${m.page}: ${m.snippet}...</a>`;
        resultsList.appendChild(li);
      });
    }
  });

  // --- SCROLL LINK HANDLER ---
  document.addEventListener('click', function(e) {
    const a = e.target.closest('a');
    if (a && a.getAttribute('href')?.match(/#page-(\d+)/)) {
      const match = a.getAttribute('href').match(/#page-(\d+)/);
      if (match) {
        e.preventDefault();
        document.getElementById(match[0].substring(1))
          .scrollIntoView({ behavior: 'smooth' });
      }
    }
  });
</script>
</body>
</html>
